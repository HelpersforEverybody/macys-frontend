<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Extractor · Vibrant UI</title>

  <!-- Socket.IO CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    /* ========== Theme ========== */
    :root{
      --bg-1: #0f1724;
      --bg-2: linear-gradient(180deg,#071021 0%, #082033 100%);
      --card: rgba(255,255,255,0.03);
      --muted: #9fb0c9;
      --accent-1: #7c5cff;
      --accent-2: #6be0ff;
      --accent-3: #ff7aa2;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      --shadow: 0 8px 30px rgba(2,6,23,0.6);
      --maxw:1100px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    html,body{height:100%;margin:0;background:var(--bg-2); color:#eaf6ff;}
    .wrap{max-width:var(--maxw); margin:36px auto;padding:22px;box-sizing:border-box;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    .logo{
      width:60px;height:60px;border-radius:14px;
      background:conic-gradient(from 200deg at 50% 50%, var(--accent-1), var(--accent-2), var(--accent-3));
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#022;box-shadow:0 10px 30px rgba(12,10,25,0.5)
    }
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    /* main card */
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .form-row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
    label{display:block;font-size:13px;color:var(--muted); margin-bottom:6px}
    textarea{width:100%;min-height:160px;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px;resize:vertical;box-sizing:border-box}
    .select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .controls{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700;font-size:14px;
      background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:#061024; box-shadow:0 8px 22px rgba(10,10,30,0.6)
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
    .status{margin-left:auto;color:var(--muted);font-size:13px}

    .meta{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px;border:1px solid rgba(255,255,255,0.02)}

    /* Table area */
    .table-wrap{
      margin-top:18px;
      border-radius:12px;
      overflow:auto;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.03);
      max-height:420px; /* vertical scroll cap */
      position:relative;
    }
    table{width:100%;border-collapse:collapse;min-width:900px}
    thead th{
      position:sticky; top:0; z-index:2;
      background: linear-gradient(90deg, rgba(9,12,30,0.9), rgba(9,12,30,0.85));
      padding:12px 14px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:0.6px;border-bottom:1px solid rgba(255,255,255,0.03);
    }
    tbody td{padding:12px 14px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px;color:#dff3ff}
    tbody tr:nth-child(even) td{background: linear-gradient(90deg, rgba(255,255,255,0.006), rgba(255,255,255,0.002));}
    tbody tr:hover td{background: rgba(255,255,255,0.02)}
    .col-sr{width:70px}
    .col-sku{width:220px}
    .col-url{max-width:540px;word-break:break-all;color:#bfe8ff;font-size:13px}
    .col-price{font-weight:800;color:#fff}
    .small{font-size:13px;color:var(--muted)}

    /* footer */
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}

    /* responsive tweak */
    @media (max-width:900px){
      .col-url{max-width:360px}
      .table-wrap{max-height:340px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">EX</div>
      <div>
        <h1>Product Extractor</h1>
        <p class="lead">Paste Macy’s product links, submit and watch your extraction queue. CSV preview shows below — table is fully scrollable.</p>
      </div>
      <div id="connStatus" class="small" style="margin-left:auto;color:#9fb0c9">Connecting...</div>
    </header>

    <main class="card" role="main" aria-live="polite">
      <label for="urls">Product URLs (one per line)</label>
      <textarea id="urls" placeholder="https://www.macys.com/shop/product/..." aria-label="Product URLs"></textarea>

      <div class="controls">
        <button id="submitBtn" class="btn" aria-label="Submit to queue">Submit</button>
        <a id="downloadBtn" class="btn ghost" style="display:none" download>Download CSV</a>
        <button id="clearBtn" class="btn ghost">Clear</button>
        <div class="status" id="status">Not connected</div>
      </div>

      <div class="meta" aria-hidden="false">
        <div class="chip" id="queueInfo">Queue: 0</div>
        <div class="chip" id="posInfo">Position: -</div>
        <div class="chip" id="itemsInfo">Items: -</div>
      </div>

      <div id="resultsArea" class="table-wrap" style="display:none">
        <table id="resultsTable" role="table" aria-label="Extraction results table">
          <!-- header will be injected -->
        </table>
      </div>

    </main>

    <footer>
      <span class="small">Tip: keep ngrok and your local server running. If sockets fail, switch BACKEND to polling (see console).</span>
    </footer>
  </div>

  <script>
    // ======= CONFIG =======
    const BACKEND = 'https://synonymous-julie-trilaterally.ngrok-free.dev'; // <-- set your ngrok URL here (no trailing spaces)
    // ======================

    // DOM
    const statusEl = document.getElementById('status');
    const connStatusEl = document.getElementById('connStatus');
    const queueInfo = document.getElementById('queueInfo');
    const posInfo = document.getElementById('posInfo');
    const itemsInfo = document.getElementById('itemsInfo');
    const resultsArea = document.getElementById('resultsArea');
    const resultsTable = document.getElementById('resultsTable');
    const downloadBtn = document.getElementById('downloadBtn');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const urlsInput = document.getElementById('urls');

    // utility
    function setStatus(t){ statusEl.innerText = t; }
    function setConn(t){ connStatusEl.innerText = t; }
    function safeBackend(){ return (typeof BACKEND === 'string' ? BACKEND.trim() : BACKEND); }

    // socket
    let socket = null;
    function connectSocket(){
      const backend = safeBackend();
      console.log('Socket connect to:', backend);
      setConn('Connecting...');
      // try websocket first; if it errors, client will fall back to polling automatically
      try {
        socket = io(backend, { transports:['websocket','polling'], path: '/socket.io', timeout: 10000 });
      } catch(e){
        console.error('Socket init error', e);
        setConn('Socket init error');
        setStatus('Socket error — check BACKEND');
        return;
      }

      socket.on('connect', ()=>{ setConn('Connected'); setStatus('Ready'); console.log('Socket connected', socket.id); });
      socket.on('connect_error', (err) => {
        console.warn('Socket connect_error', err);
        setConn('Socket error');
        setStatus('Socket connect error — see console');
      });
      socket.on('error', (e)=>{ console.error('Socket error', e); setStatus('Socket error'); });

      socket.on('queue_update', payload => {
        setStatus(payload.message || `Position ${payload.position || '?'} / ${payload.total || '?'}`);
        queueInfo.innerText = `Queue: ${payload.total || 0}`;
        posInfo.innerText = `Position: ${payload.position || '-'}`;
      });

      socket.on('extraction_complete', async data => {
        const rel = data.downloadUrl || '';
        const full = rel.startsWith('http') ? rel : (safeBackend() + rel);
        downloadBtn.href = full; downloadBtn.style.display = 'inline-block';
        setStatus('Extraction complete — fetching preview...');
        itemsInfo.innerText = `Items: ${data.totalItems || '-'}`;
        try {
          const res = await fetch(full);
          if(!res.ok) throw new Error('CSV fetch returned ' + res.status);
          const text = await res.text();
          renderTableFromCsv(text);
          setStatus('Preview ready • Click Download to save');
        } catch(err){
          console.error('Failed to fetch CSV preview', err);
          setStatus('Extraction complete — click Download to save file');
        }
      });
    }

    // CSV parsing (simple but handles quoted fields)
    function csvToRows(csv){
      const lines = csv.split(/\r?\n/).filter(l=>l.trim()!=='');
      return lines.map(l=>{
        const cells = []; let cur=''; let inQuotes=false;
        for(let i=0;i<l.length;i++){
          const ch = l[i];
          if(ch === '"'){ if(inQuotes && l[i+1] === '"'){ cur += '"'; i++; continue;} inQuotes = !inQuotes; continue; }
          if(ch === ',' && !inQuotes){ cells.push(cur); cur=''; continue; }
          cur += ch;
        }
        cells.push(cur);
        return cells;
      });
    }

    function renderTableFromCsv(csv){
      const rows = csvToRows(csv);
      if(!rows || rows.length===0){ resultsArea.style.display='none'; resultsTable.innerHTML=''; return; }
      resultsArea.style.display = 'block';
      // header
      const header = rows[0];
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      header.forEach(h => { const th = document.createElement('th'); th.innerText = h.replace(/^"|"$/g,''); trh.appendChild(th); });
      thead.appendChild(trh);

      // body (cap 1000 rows)
      const tbody = document.createElement('tbody');
      rows.slice(1, 1001).forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.innerText = (cell||'').replace(/^'|^"|"$/g,'');
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      resultsTable.innerHTML = '';
      resultsTable.appendChild(thead);
      resultsTable.appendChild(tbody);

      // nice scroll to top
      resultsArea.scrollTop = 0;
      resultsArea.scrollLeft = 0;
    }

    async function submitToQueue(){
      if(!socket || socket.disconnected){ alert('Socket not connected. Start ngrok & server.'); return; }
      const raw = urlsInput.value.trim();
      if(!raw){ alert('Paste one or more URLs (one per line).'); return; }
      const urls = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      setStatus('Submitting...');
      try {
        const res = await fetch(safeBackend() + '/queue_submit', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ site: 'macys', urls })
        });
        if(!res.ok){ const t = await res.text(); throw new Error(t || 'Server error'); }
        const json = await res.json();
        setStatus(json.message || 'Submitted — waiting in queue');
        const userId = json.userId || json.id || json.room;
        if(userId) socket.emit('join_queue', userId);
      } catch (err){
        console.error('Submit error', err);
        alert('Submit failed: ' + (err.message || err));
        setStatus('Submit failed');
      }
    }

    // wire buttons
    submitBtn.addEventListener('click', e => { e.preventDefault(); submitToQueue(); });
    clearBtn.addEventListener('click', ()=> urlsInput.value = '');

    // init
    connectSocket();

    // exps
    window.__EXTRACTOR = { connectSocket, submitToQueue, renderTableFromCsv };
  </script>
</body>
</html>
