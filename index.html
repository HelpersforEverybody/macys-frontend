<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Extractor — UI refinements + Site auto-detect</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
  :root{
    --maxw:1200px;
    --radius:12px;
    --muted-dark:#9fb0c9;
    --muted-light:#475569;
    --accent:#2563eb;
    --green:#10b981;
    --card-border: rgba(0,0,0,0.08);
    --shadow: 0 12px 30px rgba(0,0,0,0.35);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  /* themes */
  :root[data-theme="dark"]{
    --page-bg:#07111a;
    --card-bg: rgba(255,255,255,0.02);
    --text:#eaf6ff;
    --muted:var(--muted-dark);
    --input-bg:rgba(255,255,255,0.01);
    --btn-text:#fff;
    --header-shadow: rgba(0,0,0,0.6);
    --header-bg: #07111a;
  }
  :root[data-theme="light"]{
    --page-bg:#f3f7fb;
    --card-bg:#ffffff;
    --text:#071021;
    --muted:var(--muted-light);
    --input-bg:#ffffff;
    --btn-text:#fff;
    --header-shadow: rgba(0,0,0,0.06);
    --header-bg: #ffffff;
  }
  html,body{height:100%;margin:0;overflow-x:hidden;background:var(--page-bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:var(--maxw);margin:28px auto;padding:18px;box-sizing:border-box}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  .logo{width:56px;height:56px;border-radius:12px;background:var(--card-bg);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--text);box-shadow:var(--shadow)}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .main-card{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
  textarea{width:100%;min-height:140px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:var(--input-bg);color:var(--text);font-size:14px;box-sizing:border-box;resize:vertical}
  .controls{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:14px;color:var(--btn-text)}
  .btn-primary{background:var(--accent)}
  .btn-download{background:var(--green)}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted);font-weight:600}
  .status{margin-left:auto;color:var(--muted);font-size:13px}
  .meta{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px;border:1px solid rgba(255,255,255,0.02)}
  /* results viewport */
  .table-wrap{margin-top:18px;border-radius:12px;background:var(--card-bg);border:1px solid var(--card-border);max-height:520px;padding:0;overflow:auto}
  .table-top{padding:8px 12px; display:flex; justify-content:space-between; align-items:center;}
  .table-top .muted{color:var(--muted);font-size:13px}
  .table-wrap{ scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.25) rgba(255,255,255,0.02); }
  .table-wrap::-webkit-scrollbar{ height:12px; width:12px; }
  .table-wrap::-webkit-scrollbar-track{ background: rgba(255,255,255,0.02); border-radius:6px; }
  .table-wrap::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.25); border-radius:6px; border:2px solid rgba(0,0,0,0); }
  table{width:100%;border-collapse:collapse;min-width:1100px;table-layout:auto}
  thead th{ position:sticky; top:0; z-index:6; background: var(--header-bg); padding:12px 14px; color:var(--muted); font-size:12px; text-transform:uppercase; border-bottom:1px solid rgba(0,0,0,0.06); font-weight:700; box-shadow: 0 2px 6px var(--header-shadow); }
  tbody td{padding:12px 14px;border-bottom:1px dashed rgba(0,0,0,0.04);font-size:14px;color:var(--text)}
  tbody tr:nth-child(even) td{background: rgba(0,0,0,0.015)}
  tbody tr:hover td{background: rgba(0,0,0,0.02)}
  .col-sr{width:60px;white-space:nowrap}
  .col-sku{width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .col-upc{width:140px;white-space:nowrap}
  .col-url{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#1ea7ff}
  .col-color{width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .col-size{width:90px;white-space:nowrap}
  .col-price{width:110px;white-space:nowrap}
  .col-regular{width:110px;white-space:nowrap}
  .col-avail{width:120px;white-space:nowrap}
  .footer-note{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
  @media(max-width:900px){ .col-url{max-width:150px} }
  .switch { position:relative; width:54px; height:30px; border-radius:999px; background: rgba(255,255,255,0.06); display:inline-block; cursor:pointer; border:1px solid rgba(0,0,0,0.06)}
  .switch .knob{ position:absolute; left:4px; top:4px; width:22px; height:22px; border-radius:50%; background: #fff; transition: transform .18s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.25) }
  :root[data-theme="dark"] .switch{ background: rgba(255,255,255,0.03) }
  :root[data-theme="light"] .switch{ background: rgba(0,0,0,0.04) }
  .switch.on{ background: var(--accent); }
  .switch.on .knob{ transform: translateX(24px); background:#fff; }
  .toggle-wrap{ display:flex; align-items:center; gap:8px; }
  .url-cell { max-width:180px; }
  .url-cell a { color: #1ea7ff; text-decoration: none; display:block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }
  .url-cell a:hover { text-decoration:underline; }
  .url-counter { background: rgba(0,0,0,0.06); color: var(--muted); padding:6px 10px; border-radius:999px; font-weight:700; margin-left:8px; }
  :root[data-theme="light"] .url-counter { background: rgba(0,0,0,0.04); color:var(--muted); }
  .site-chip { font-weight:800; padding:8px 12px; border-radius:10px; background:rgba(0,0,0,0.04); color:var(--muted); }
  .progress-wrap { display:flex; align-items:center; gap:12px; margin-left:12px; }
  .circle { width:72px; height:72px; position:relative; display:inline-block; }
  .circle svg { transform: rotate(-90deg); width:100%; height:100%; display:block; }
  .circle .bg { stroke: rgba(255,255,255,0.06); stroke-width:8; fill:none; }
  .circle .bar { stroke: var(--green); stroke-width:8; stroke-linecap:round; fill:none; transition: stroke-dashoffset 400ms linear; }
  .circle .percent { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--text); font-size:14px; pointer-events:none; }
  .progress-label { font-size:13px; color:var(--muted); }
  @media(max-width:700px){ .circle{ width:58px; height:58px; } .circle .percent { font-size:12px; } }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">EX</div>
      <div>
        <h1>Product Extractor</h1>
        <p class="lead">Paste product links — extraction runs on your laptop. Full preview below; table scrolls inside the box.</p>
      </div>

      <div style="margin-left:auto">
        <div class="toggle-wrap">
          <div style="color:var(--muted);font-size:13px;margin-right:8px">Theme</div>
          <div id="themeSwitch" class="switch" role="switch" aria-checked="false" tabindex="0">
            <div class="knob"></div>
          </div>
        </div>
      </div>
    </header>

    <main class="main-card" role="main" aria-live="polite">
      <label for="urls">Product URLs (one per line)</label>
      <textarea id="urls" placeholder="https://www.macys.com/shop/product/..." aria-label="Product URLs"></textarea>

      <div class="controls">
        <button id="submitBtn" class="btn btn-primary">Submit</button>
        <!-- download is a normal anchor so users can always click to download (works even if preview fetch fails) -->
        <a id="downloadBtn" class="btn btn-download" style="display:none" download target="_blank" rel="noopener">Download CSV</a>
        <button id="clearBtn" class="btn btn-ghost">Clear</button>

        <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
          <div class="status" id="status">Not connected</div>

          <div class="progress-wrap" id="progressWrap" aria-hidden="true" style="display:none">
            <div class="circle" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" id="progressCircle">
              <svg viewBox="0 0 100 100">
                <circle class="bg" cx="50" cy="50" r="40"></circle>
                <circle class="bar" cx="50" cy="50" r="40" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
              </svg>
              <div class="percent" id="progressText">0%</div>
            </div>
            <div>
              <div class="progress-label" id="progressLabel">Idle</div>
            </div>
          </div>
        </div>
      </div>

      <div class="meta">
        <div class="chip" id="queueInfo">Queue: 0</div>
        <div class="chip" id="posInfo">Position: -</div>
        <div class="chip" id="itemsInfo">Items: -</div>

        <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
          <div style="color:var(--muted);font-size:13px">Site:</div>
          <div class="site-chip" id="siteChip">macys</div>
          <div style="color:var(--muted);font-size:13px">URLs:</div>
          <div class="url-counter" id="urlCount">0</div>
        </div>
      </div>

      <div id="resultsArea" class="table-wrap" style="display:none">
        <div class="table-top">
          <div class="muted" id="rowsInfo">Showing: 0 rows</div>
          <div class="muted" id="previewHint">Full preview — scroll horizontally or vertically</div>
        </div>

        <table id="resultsTable" role="table" aria-label="Extraction results table"></table>
      </div>
    </main>

    <div class="footer-note">Tip: keep ngrok & local server running. Download removes the file from the server after transfer.</div>
  </div>

<script>
  // ===== CONFIG: set your ngrok/backend URL =====
  const BACKEND = 'https://synonymous-julie-trilaterally.ngrok-free.dev';
  // =============================================

  // DOM refs
  const urlsInput = document.getElementById('urls');
  const submitBtn = document.getElementById('submitBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const statusEl = document.getElementById('status');
  const queueInfo = document.getElementById('queueInfo');
  const posInfo = document.getElementById('posInfo');
  const itemsInfo = document.getElementById('itemsInfo');
  const resultsArea = document.getElementById('resultsArea');
  const resultsTable = document.getElementById('resultsTable');
  const rowsInfo = document.getElementById('rowsInfo');
  const previewHint = document.getElementById('previewHint');
  const themeSwitch = document.getElementById('themeSwitch');
  const urlCountEl = document.getElementById('urlCount');
  const siteChip = document.getElementById('siteChip');

  // progress elements
  const progressWrap = document.getElementById('progressWrap');
  const progressBar = document.querySelector('.circle .bar');
  const progressText = document.getElementById('progressText');
  const progressLabel = document.getElementById('progressLabel');
  const CIRCLE_R = 40;
  const CIRCLE_CIRC = Math.PI * 2 * CIRCLE_R;
  progressBar.style.strokeDasharray = CIRCLE_CIRC;
  progressBar.style.strokeDashoffset = CIRCLE_CIRC;

  // tracked site (auto-detected) - default macys
  let currentSite = 'macys';

  function safeBackend(){ return (typeof BACKEND === 'string') ? BACKEND.trim() : BACKEND; }
  function setStatus(t){ statusEl.innerText = t; }

  // theme init and switch handling
  (function initTheme(){
    const saved = localStorage.getItem('extractor_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    if(saved === 'light'){ themeSwitch.classList.add('on'); themeSwitch.setAttribute('aria-checked','true'); themeSwitch.querySelector('.knob').style.transform = 'translateX(24px)'; }
  })();
  function toggleTheme(){
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('extractor_theme', next);
    if(next === 'light'){ themeSwitch.classList.add('on'); themeSwitch.setAttribute('aria-checked','true'); themeSwitch.querySelector('.knob').style.transform = 'translateX(24px)'; }
    else { themeSwitch.classList.remove('on'); themeSwitch.setAttribute('aria-checked','false'); themeSwitch.querySelector('.knob').style.transform = 'translateX(0)'; }
  }
  themeSwitch.addEventListener('click', toggleTheme);
  themeSwitch.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTheme(); } });

  // Utility: detect site from single URL (simple heuristics by hostname)
  function detectSiteFromUrl(url) {
    try {
      const u = new URL(url);
      const host = u.hostname.toLowerCase();
      if(host.includes('macys')) return 'macys';
      if(host.includes('kohls')) return 'kohls';
      if(host.includes('belk')) return 'belk';
      return 'macys';
    } catch(e){ return 'macys'; }
  }

  // Update site chip and currentSite based on pasted URLs
  function updateSiteFromUrls() {
    const raw = urlsInput.value || '';
    const urls = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(urls.length === 0) {
      currentSite = 'macys';
      siteChip.innerText = currentSite;
      return;
    }
    const firstSite = detectSiteFromUrl(urls[0]);
    currentSite = firstSite;
    siteChip.innerText = currentSite;
  }

  // CSV parser (handles quoted commas)
  function csvToRows(csv){
    const lines = csv.split(/\r?\n/);
    const rows = [];
    for (let raw of lines) {
      if(raw.trim() === '') continue;
      const cells = [];
      let cur = '';
      let inQ = false;
      for (let i=0;i<raw.length;i++){
        const ch = raw[i];
        if (ch === '"') {
          if (inQ && raw[i+1] === '"') { cur += '"'; i++; continue; }
          inQ = !inQ;
          continue;
        }
        if (ch === ',' && !inQ) {
          cells.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      cells.push(cur);
      rows.push(cells);
    }
    return rows;
  }

  // Normalize header names to make mapping easier
  function normalizeHeader(h){ return String(h||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,' '); }

  // render full CSV into table, but handle site-specific CSVs gracefully
  function renderTableFromCsv(csv, siteHint = 'macys'){
    try {
      const rows = csvToRows(csv);
      if(!rows || rows.length === 0){ resultsArea.style.display='none'; resultsTable.innerHTML=''; rowsInfo.innerText='Showing: 0 rows'; return; }
      // Use first row as header if it seems like a header (contains letters)
      let header = rows[0].map(c => c.replace(/^"|"$/g,''));
      let dataRows = rows.slice(1);
      // If first row looks like data not header (e.g., numeric first cell '1'), try to detect columns by siteHint
      const firstCell = (header[0] || '').trim();
      if (/^\d+$/.test(firstCell) && header.length > 1) {
        // assume header is present; nothing to do
      }

      // If header columns are not the expected for a site, try to synthesize header for known site shapes
      const headerLower = header.map(h=>normalizeHeader(h));
      if (siteHint === 'kohls') {
        // Kohl's expected header names (if CSV lacks header, detect by length)
        const kohlsExpected = ['sr no','upc id','product','colour','size','size range','your price','sale price','regular price','stock available','availability','ship available','max allowed per order'];
        if (headerLower.every(h => h === '' || /^\d+$/.test(h))) {
          // weird: no header; create one based on expected columns if lengths match
          if (dataRows[0] && dataRows[0].length === kohlsExpected.length) {
            header = kohlsExpected;
            dataRows = rows.slice(0); // treat all rows as data
          }
        }
      }

      // Build table
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      header.forEach(h => {
        const th = document.createElement('th');
        th.innerText = (h||'').toString().replace(/^"|"$/g,'');
        const key = normalizeHeader(h);
        if(key.includes('sr') || key.includes('no')) th.className = 'col-sr';
        else if(key.includes('sku')) th.className = 'col-sku';
        else if(key.includes('upc')) th.className = 'col-upc';
        else if(key.includes('url')) th.className = 'col-url';
        else if(key.includes('product') || key.includes('name')) th.className = 'col-sku';
        else if(key.includes('colour') || key.includes('color')) th.className = 'col-color';
        else if(key.includes('size range') || key.includes('size')) th.className = 'col-size';
        else if(key.includes('your price') || key.includes('current') || key.includes('yourprice')) th.className = 'col-price';
        else if(key.includes('regular')) th.className = 'col-regular';
        else if(key.includes('avail') || key.includes('stock')) th.className = 'col-avail';
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      const tbody = document.createElement('tbody');
      dataRows.forEach(r => {
        const tr = document.createElement('tr');
        for (let idx=0; idx < header.length; idx++){
          const td = document.createElement('td');
          const raw = (r[idx]||'').replace(/^'|^"|"$/g,'');
          const h = header[idx] ? normalizeHeader(header[idx]) : '';
          // If there's a URL-like value, make it a link
          if (/^https?:\/\//i.test(raw) || h.includes('url')) {
            const a = document.createElement('a');
            a.href = raw || '#';
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.innerText = truncateUrl(raw);
            a.title = raw;
            td.appendChild(a);
            td.className = 'col-url url-cell';
          } else {
            td.innerText = raw;
          }
          // add classes similar to header mapping
          if(h.includes('sr') || h.includes('no')) td.classList.add('col-sr');
          if(h.includes('sku') || h.includes('product') || h.includes('name')) td.classList.add('col-sku');
          if(h.includes('upc')) td.classList.add('col-upc');
          if(h.includes('colour') || h.includes('color')) { td.classList.add('col-color'); td.title = raw; }
          if(h.includes('size')) td.classList.add('col-size');
          if(h.includes('your price') || h.includes('current') || h.includes('yourprice')) td.classList.add('col-price');
          if(h.includes('regular')) td.classList.add('col-regular');
          if(h.includes('avail') || h.includes('stock')) td.classList.add('col-avail');

          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });

      resultsTable.innerHTML = '';
      resultsTable.appendChild(thead);
      resultsTable.appendChild(tbody);

      resultsArea.style.display = 'block';
      rowsInfo.innerText = `Showing: ${dataRows.length} rows`;
      // Reset scroll so sticky header visually covers content
      resultsArea.scrollTop = 0;
      resultsArea.scrollLeft = 0;
    } catch (e) {
      console.error('renderTableFromCsv failed', e);
      resultsArea.style.display = 'none';
      rowsInfo.innerText = 'Preview unavailable';
    }
  }

  // truncate URL (unchanged)
  function truncateUrl(url, maxLength = 40) {
    if (!url || url.length <= maxLength) return url;
    try {
      const urlObj = new URL(url);
      const domain = urlObj.hostname;
      const path = urlObj.pathname + urlObj.search;
      if (domain.length + 10 >= maxLength) {
        return domain.substring(0, maxLength - 3) + '...';
      }
      const availableForPath = maxLength - domain.length - 3;
      if (path.length > availableForPath) {
        return domain + path.substring(0, availableForPath) + '...';
      }
      return domain + path;
    } catch (e) {
      return url.length > maxLength ? url.substring(0, maxLength - 3) + '...' : url;
    }
  }

  // Progress helpers
  let progressInterval = null;
  let progressValue = 0;
  function showProgressUI(show){ progressWrap.style.display = show ? 'flex' : 'none'; progressWrap.setAttribute('aria-hidden', show ? 'false' : 'true'); }
  function setProgress(n){ if(n<0) n=0; if(n>100) n=100; progressValue=n; const offset=CIRCLE_CIRC*(1-(n/100)); progressBar.style.strokeDashoffset=offset; progressText.innerText=Math.round(n)+'%'; document.getElementById('progressCircle').setAttribute('aria-valuenow', String(Math.round(n))); }
  function startProgressAuto(){ showProgressUI(true); setProgress(0); progressLabel.innerText='Extracting'; clearInterval(progressInterval); progressInterval=setInterval(()=>{ if(progressValue>=95){ clearInterval(progressInterval); return; } const step=0.5+Math.random()*(1.5*(1-progressValue/100)); setProgress(Math.min(95, progressValue+step)); },350); }
  function completeProgress(){ clearInterval(progressInterval); setProgress(100); progressLabel.innerText='Complete'; setTimeout(()=> showProgressUI(false),1800); }
  function resetProgress(){ clearInterval(progressInterval); setProgress(0); progressLabel.innerText='Idle'; showProgressUI(false); }

  // socket + CSV behavior
  let socket = null;
  function connectSocket(){
    const backend = safeBackend();
    setStatus('Connecting...');
    try {
      socket = io(backend, { transports:['websocket','polling'], path:'/socket.io', timeout:10000 });
    } catch(e){ console.error('Socket init', e); setStatus('Socket init error'); return; }

    socket.on('connect', ()=> { setStatus('Ready'); console.log('socket connected', socket.id); });
    socket.on('connect_error', err => { console.warn('connect_error', err); setStatus('Socket error'); });
    socket.on('queue_update', payload => {
      const msg = payload.message || '';
      setStatus(msg || `Position ${payload.position || '?'} / ${payload.total || '?'}`);
      queueInfo.innerText = `Queue: ${payload.total || 0}`;
      posInfo.innerText = `Position: ${payload.position || '-'}`;
      const lower = (msg || '').toString().toLowerCase();
      if(lower.includes('extract') || lower.includes('extracting') || lower.includes('your turn - extracting')) startProgressAuto();
    });

    socket.on('progress', payload => {
      try {
        const done = Number(payload.done) || 0;
        const total = Number(payload.total) || 0;
        if (total > 0) {
          const pct = Math.min(100, (done / total) * 100);
          setProgress(pct);
          progressLabel.innerText = `${done} / ${total}`;
        } else {
          progressLabel.innerText = `${done} items`;
          startProgressAuto();
        }
      } catch (e) { console.warn('progress parse failed', e); }
    });

    socket.on('extraction_complete', async data => {
      const rel = data.downloadUrl || '';
      const full = rel.startsWith('http') ? rel : (safeBackend() + rel);
      // Ensure download anchor always present for manual download
      downloadBtn.href = full;
      downloadBtn.style.display = 'inline-block';
      setStatus('Extraction complete — fetching preview...');
      itemsInfo.innerText = `Items: ${data.totalItems || '-'}`;

      // finalize progress
      completeProgress();

      // Try to fetch preview; if it fails show helpful message but leave download button available
      try {
        const res = await fetch(full, { cache: 'no-store' });
        if (!res.ok) throw new Error('Fetch status ' + res.status);
        const text = await res.text();
        // render according to detected site
        renderTableFromCsv(text, currentSite);
        setStatus('Preview ready — click Download to save');
      } catch (err) {
        console.warn('Preview fetch failed', err);
        setStatus('Preview unavailable — click Download to save file');
        // ensure results area shows message
        resultsArea.style.display = 'block';
        resultsTable.innerHTML = '<thead><tr><th>Preview</th></tr></thead><tbody><tr><td>Preview not available. Please click Download to save CSV.</td></tr></tbody>';
        rowsInfo.innerText = `Showing: -`;
      }
    });
  }
  connectSocket();

  // submit: sends detected site along with urls
  async function submitToQueue(){
    if(!socket || socket.disconnected){ alert('Socket not connected. Start ngrok & server.'); return; }
    const raw = urlsInput.value.trim();
    if(!raw){ alert('Paste one or more URLs (one per line).'); return; }
    const urls = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    setStatus('Submitting...');
    try {
      const payload = { site: currentSite, urls };
      const res = await fetch(safeBackend() + '/queue_submit', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){ const t = await res.text(); throw new Error(t || 'Server error'); }
      const json = await res.json();
      setStatus(json.message || 'Submitted — waiting in queue');
      const userId = json.userId || json.id || json.room;
      if(userId) socket.emit('join_queue', userId);

      // start client-side progress visualization
      startProgressAuto();
    } catch(err){
      console.error('Submit error', err);
      alert('Submit failed: ' + (err.message || err));
      setStatus('Submit failed');
    }
  }

  // URL counter + site detection update logic
  function updateUrlCountAndSite(){
    const raw = urlsInput.value || '';
    const urls = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const count = urls.length;
    urlCountEl.textContent = count;
    if(urls.length > 0) {
      const detected = detectSiteFromUrl(urls[0]);
      currentSite = detected;
      siteChip.innerText = detected;
    } else {
      currentSite = 'macys';
      siteChip.innerText = currentSite;
    }
  }
  urlsInput.addEventListener('input', updateUrlCountAndSite);
  urlsInput.addEventListener('paste', () => setTimeout(updateUrlCountAndSite, 50));
  updateUrlCountAndSite();

  // UI wiring
  submitBtn.addEventListener('click', e => { e.preventDefault(); submitToQueue(); });
  clearBtn.addEventListener('click', ()=> {
    urlsInput.value=''; resultsArea.style.display='none'; resultsTable.innerHTML=''; downloadBtn.style.display='none';
    rowsInfo.innerText='Showing: 0 rows'; updateUrlCountAndSite(); resetProgress();
  });

  // expose for debug
  window.__EXTRACTOR = { renderTableFromCsv, submitToQueue, connectSocket, setProgress, startProgressAuto, completeProgress };

  // init: hide progress
  resetProgress();
</script>
</body>
</html>
