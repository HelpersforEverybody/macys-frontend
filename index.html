<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Extractor — UI refinements</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
  :root{
    --maxw:1200px;
    --radius:12px;
    --muted-dark:#9fb0c9;
    --muted-light:#475569;
    --accent:#2563eb;
    --green:#10b981;
    --card-border: rgba(0,0,0,0.08);
    --shadow: 0 12px 30px rgba(0,0,0,0.35);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }

  /* themes */
  :root[data-theme="dark"]{
    --page-bg:#07111a;
    --card-bg: rgba(255,255,255,0.02);
    --text:#eaf6ff;
    --muted:var(--muted-dark);
    --input-bg:rgba(255,255,255,0.01);
    --btn-text:#fff;
    --header-shadow: rgba(0,0,0,0.6);
    --header-bg: #07111a; /* Fully opaque dark theme header background */
  }
  :root[data-theme="light"]{
    --page-bg:#f3f7fb;
    --card-bg:#ffffff;
    --text:#071021;
    --muted:var(--muted-light);
    --input-bg:#ffffff;
    --btn-text:#fff;
    --header-shadow: rgba(0,0,0,0.06);
    --header-bg: #ffffff; /* Fully opaque light theme header background */
  }

  html,body{height:100%;margin:0;overflow-x:hidden;background:var(--page-bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:var(--maxw);margin:28px auto;padding:18px;box-sizing:border-box}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  .logo{width:56px;height:56px;border-radius:12px;background:var(--card-bg);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--text);box-shadow:var(--shadow)}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .main-card{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
  textarea{width:100%;min-height:140px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:var(--input-bg);color:var(--text);font-size:14px;box-sizing:border-box;resize:vertical}

  .controls{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:14px;color:var(--btn-text)}
  .btn-primary{background:var(--accent)}
  .btn-download{background:var(--green)}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted);font-weight:600}

  .status{margin-left:auto;color:var(--muted);font-size:13px}
  .meta{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px;border:1px solid rgba(255,255,255,0.02)}

  /* results viewport */
  .table-wrap{margin-top:18px;border-radius:12px;background:var(--card-bg);border:1px solid var(--card-border);max-height:520px;padding:0;overflow:auto}
  .table-top{padding:8px 12px; display:flex; justify-content:space-between; align-items:center;}
  .table-top .muted{color:var(--muted);font-size:13px}

  /* scrollbar styles (visible) */
  .table-wrap{ scrollbar-width: thin; scrollbar-color: rgba(0,0,0,0.25) rgba(255,255,255,0.02); }
  .table-wrap::-webkit-scrollbar{ height:12px; width:12px; }
  .table-wrap::-webkit-scrollbar-track{ background: rgba(255,255,255,0.02); border-radius:6px; }
  .table-wrap::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.25); border-radius:6px; border:2px solid rgba(0,0,0,0); }

  table{width:100%;border-collapse:collapse;min-width:1100px;table-layout:auto}
  thead th{
    position:sticky; top:0; z-index:6;
    background: var(--header-bg); /* Fully opaque background - different per theme */
    padding:12px 14px; color:var(--muted); font-size:12px; text-transform:uppercase;
    border-bottom:1px solid rgba(0,0,0,0.06);
    font-weight:700; /* Bold header text */
    box-shadow: 0 2px 6px var(--header-shadow);
  }
  tbody td{padding:12px 14px;border-bottom:1px dashed rgba(0,0,0,0.04);font-size:14px;color:var(--text)}
  tbody tr:nth-child(even) td{background: rgba(0,0,0,0.015)}
  tbody tr:hover td{background: rgba(0,0,0,0.02)}

  /* column helpers */
  .col-sr{width:60px;white-space:nowrap}
  .col-sku{width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .col-upc{width:140px;white-space:nowrap}
  /* URL column: truncated display with max-width */
  .col-url{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#1ea7ff}
  .col-color{width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .col-size{width:90px;white-space:nowrap}
  .col-price{width:110px;white-space:nowrap;font-weight:normal}
  .col-regular{width:110px;white-space:nowrap}
  .col-avail{width:120px;white-space:nowrap}

  .footer-note{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
  @media(max-width:900px){ .col-url{max-width:150px} }

  /* Toggle switch */
  .switch { position:relative; width:54px; height:30px; border-radius:999px; background: rgba(255,255,255,0.06); display:inline-block; cursor:pointer; border:1px solid rgba(0,0,0,0.06)}
  .switch .knob{ position:absolute; left:4px; top:4px; width:22px; height:22px; border-radius:50%; background: #fff; transition: transform .18s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.25) }
  :root[data-theme="dark"] .switch{ background: rgba(255,255,255,0.03) }
  :root[data-theme="light"] .switch{ background: rgba(0,0,0,0.04) }
  .switch.on{ background: var(--accent); }
  .switch.on .knob{ transform: translateX(24px); background:#fff; }
  .toggle-wrap{ display:flex; align-items:center; gap:8px; }

  /* URL link styling with truncation */
  .url-cell { max-width:180px; }
  .url-cell a { 
    color: #1ea7ff; 
    text-decoration: none; 
    display:block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
  }
  .url-cell a:hover { text-decoration:underline; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">EX</div>
      <div>
        <h1>Product Extractor</h1>
        <p class="lead">Paste Macy's product links — extraction runs on your laptop. Full preview below; table scrolls inside the box.</p>
      </div>

      <div style="margin-left:auto">
        <div class="toggle-wrap">
          <div style="color:var(--muted);font-size:13px;margin-right:8px">Theme</div>
          <div id="themeSwitch" class="switch" role="switch" aria-checked="false" tabindex="0">
            <div class="knob"></div>
          </div>
        </div>
      </div>
    </header>

    <main class="main-card" role="main" aria-live="polite">
      <label for="urls">Product URLs (one per line)</label>
      <textarea id="urls" placeholder="https://www.macys.com/shop/product/..." aria-label="Product URLs"></textarea>

      <div class="controls">
        <button id="submitBtn" class="btn btn-primary">Submit</button>
        <a id="downloadBtn" class="btn btn-download" style="display:none" download>Download CSV</a>
        <button id="clearBtn" class="btn btn-ghost">Clear</button>
        <div class="status" id="status">Not connected</div>
      </div>

      <div class="meta">
        <div class="chip" id="queueInfo">Queue: 0</div>
        <div class="chip" id="posInfo">Position: -</div>
        <div class="chip" id="itemsInfo">Items: -</div>
      </div>

      <div id="resultsArea" class="table-wrap" style="display:none">
        <div class="table-top">
          <div class="muted" id="rowsInfo">Showing: 0 rows</div>
          <div class="muted">Full preview — scroll horizontally or vertically</div>
        </div>

        <table id="resultsTable" role="table" aria-label="Extraction results table"></table>
      </div>
    </main>

    <div class="footer-note">Tip: keep ngrok & local server running. Download removes the file from the server after transfer.</div>
  </div>

<script>
  // ===== CONFIG: set your ngrok/backend URL =====
  const BACKEND = 'https://synonymous-julie-trilaterally.ngrok-free.dev';
  // =============================================

  // DOM refs
  const urlsInput = document.getElementById('urls');
  const submitBtn = document.getElementById('submitBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const statusEl = document.getElementById('status');
  const queueInfo = document.getElementById('queueInfo');
  const posInfo = document.getElementById('posInfo');
  const itemsInfo = document.getElementById('itemsInfo');
  const resultsArea = document.getElementById('resultsArea');
  const resultsTable = document.getElementById('resultsTable');
  const rowsInfo = document.getElementById('rowsInfo');
  const themeSwitch = document.getElementById('themeSwitch');

  function safeBackend(){ return (typeof BACKEND === 'string') ? BACKEND.trim() : BACKEND; }
  function setStatus(t){ statusEl.innerText = t; }

  // theme init and switch handling
  (function initTheme(){
    const saved = localStorage.getItem('extractor_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    // reflect switch UI
    if(saved === 'light'){ themeSwitch.classList.add('on'); themeSwitch.setAttribute('aria-checked','true'); themeSwitch.querySelector('.knob').style.transform = 'translateX(24px)'; }
  })();

  function toggleTheme(){
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('extractor_theme', next);
    if(next === 'light'){ themeSwitch.classList.add('on'); themeSwitch.setAttribute('aria-checked','true'); themeSwitch.querySelector('.knob').style.transform = 'translateX(24px)'; }
    else { themeSwitch.classList.remove('on'); themeSwitch.setAttribute('aria-checked','false'); themeSwitch.querySelector('.knob').style.transform = 'translateX(0)'; }
  }
  themeSwitch.addEventListener('click', toggleTheme);
  themeSwitch.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTheme(); } });

  // CSV parser
  function csvToRows(csv){
    const lines = csv.split(/\r?\n/).filter(l => l.trim() !== '');
    return lines.map(l => {
      const cells = []; let cur=''; let inQ=false;
      for(let i=0;i<l.length;i++){
        const ch = l[i];
        if(ch === '"'){ if(inQ && l[i+1] === '"'){ cur += '"'; i++; continue; } inQ = !inQ; continue; }
        if(ch === ',' && !inQ){ cells.push(cur); cur=''; continue; }
        cur += ch;
      }
      cells.push(cur);
      return cells;
    });
  }

  // Function to truncate URL for display
  function truncateUrl(url, maxLength = 40) {
    if (!url || url.length <= maxLength) return url;
    
    // Keep the domain and truncate the path
    try {
      const urlObj = new URL(url);
      const domain = urlObj.hostname;
      const path = urlObj.pathname + urlObj.search;
      
      if (domain.length + 10 >= maxLength) {
        return domain.substring(0, maxLength - 3) + '...';
      }
      
      const availableForPath = maxLength - domain.length - 3; // -3 for the ellipsis
      if (path.length > availableForPath) {
        return domain + path.substring(0, availableForPath) + '...';
      }
      
      return domain + path;
    } catch (e) {
      // If URL parsing fails, fall back to simple truncation
      return url.length > maxLength ? url.substring(0, maxLength - 3) + '...' : url;
    }
  }

  // render full CSV into table
  function renderTableFromCsv(csv){
    const rows = csvToRows(csv);
    if(!rows || rows.length === 0){ resultsArea.style.display='none'; resultsTable.innerHTML=''; rowsInfo.innerText='Showing: 0 rows'; return; }
    const header = rows[0];

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    header.forEach(h => {
      const th = document.createElement('th');
      th.innerText = h.replace(/^"|"$/g,'');
      const key = h.toString().toLowerCase();
      if(key.includes('sr')) th.className = 'col-sr';
      else if(key.includes('sku')) th.className = 'col-sku';
      else if(key.includes('upc')) th.className = 'col-upc';
      else if(key.includes('url')) th.className = 'col-url';
      else if(key.includes('color')) th.className = 'col-color';
      else if(key.includes('size')) th.className = 'col-size';
      else if(key.includes('current')) th.className = 'col-price';
      else if(key.includes('regular')) th.className = 'col-regular';
      else if(key.includes('avail')) th.className = 'col-avail';
      trh.appendChild(th);
    });
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    rows.slice(1).forEach(r => {
      const tr = document.createElement('tr');
      r.forEach((cell, idx) => {
        const td = document.createElement('td');
        const raw = (cell||'').replace(/^'|^"|"$/g,'');
        const h = header[idx] ? header[idx].toString().toLowerCase() : '';

        if(h.includes('url')){
          const a = document.createElement('a');
          a.href = raw || '#';
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.innerText = truncateUrl(raw); // Use truncated URL for display
          a.title = raw; // Full URL as tooltip
          td.appendChild(a);
          td.className = 'col-url url-cell';
        } else {
          td.innerText = raw;
        }

        if(h.includes('sr')) td.classList.add('col-sr');
        if(h.includes('sku')) td.classList.add('col-sku');
        if(h.includes('upc')) td.classList.add('col-upc');
        if(h.includes('color')){ td.classList.add('col-color'); td.title = raw; }
        if(h.includes('size')) td.classList.add('col-size');
        if(h.includes('current')) td.classList.add('col-price');
        if(h.includes('regular')) td.classList.add('col-regular');
        if(h.includes('avail')) td.classList.add('col-avail');

        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    resultsTable.innerHTML = '';
    resultsTable.appendChild(thead);
    resultsTable.appendChild(tbody);

    resultsArea.style.display = 'block';
    rowsInfo.innerText = `Showing: ${rows.length - 1} rows`;

    // ensure sticky header fully covers content: reset scroll
    resultsArea.scrollTop = 0;
    resultsArea.scrollLeft = 0;
  }

  // socket + CSV behavior (unchanged API)
  let socket = null;
  function connectSocket(){
    const backend = safeBackend();
    setStatus('Connecting...');
    try {
      socket = io(backend, { transports:['websocket','polling'], path:'/socket.io', timeout:10000 });
    } catch(e){ console.error('Socket init', e); setStatus('Socket init error'); return; }

    socket.on('connect', ()=> { setStatus('Ready'); console.log('socket connected', socket.id); });
    socket.on('connect_error', err => { console.warn('connect_error', err); setStatus('Socket error'); });
    socket.on('queue_update', payload => {
      setStatus(payload.message || `Position ${payload.position || '?'} / ${payload.total || '?'}`);
      queueInfo.innerText = `Queue: ${payload.total || 0}`;
      posInfo.innerText = `Position: ${payload.position || '-'}`;
    });

    socket.on('extraction_complete', async data => {
      const rel = data.downloadUrl || '';
      const full = rel.startsWith('http') ? rel : (safeBackend() + rel);
      downloadBtn.href = full; downloadBtn.style.display = 'inline-block';
      setStatus('Extraction complete — fetching preview...');
      itemsInfo.innerText = `Items: ${data.totalItems || '-'}`;
      try {
        const res = await fetch(full);
        if(!res.ok) throw new Error('CSV fetch returned ' + res.status);
        const text = await res.text();
        renderTableFromCsv(text);
        setStatus('Preview ready — click Download to save');
      } catch(err){
        console.error('CSV fetch failed', err);
        setStatus('Extraction complete — click Download to save file');
      }
    });
  }
  connectSocket();

  async function submitToQueue(){
    if(!socket || socket.disconnected){ alert('Socket not connected. Start ngrok & server.'); return; }
    const raw = urlsInput.value.trim();
    if(!raw){ alert('Paste one or more URLs (one per line).'); return; }
    const urls = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    setStatus('Submitting...');
    try {
      const res = await fetch(safeBackend() + '/queue_submit', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ site:'macys', urls })
      });
      if(!res.ok){ const t = await res.text(); throw new Error(t || 'Server error'); }
      const json = await res.json();
      setStatus(json.message || 'Submitted — waiting in queue');
      const userId = json.userId || json.id || json.room;
      if(userId) socket.emit('join_queue', userId);
    } catch(err){
      console.error('Submit error', err);
      alert('Submit failed: ' + (err.message || err));
      setStatus('Submit failed');
    }
  }

  // UI wiring
  submitBtn.addEventListener('click', e => { e.preventDefault(); submitToQueue(); });
  clearBtn.addEventListener('click', ()=> { urlsInput.value=''; resultsArea.style.display='none'; resultsTable.innerHTML=''; downloadBtn.style.display='none'; rowsInfo.innerText='Showing: 0 rows'; });

  function safeBackend(){ return (typeof BACKEND === 'string') ? BACKEND.trim() : BACKEND; }

  // expose for debug
  window.__EXTRACTOR = { renderTableFromCsv, submitToQueue, connectSocket, truncateUrl };
</script>
</body>
</html>
