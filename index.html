<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Extractor â€” UI refinements + Site auto-detect</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
  :root{
    --maxw:1200px;
    --radius:12px;
    --muted-dark:#9fb0c9;
    --muted-light:#475569;
    --accent:#2563eb;
    --green:#10b981;
    --card-border: rgba(0,0,0,0.08);
    --shadow: 0 12px 30px rgba(0,0,0,0.35);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }

  /* themes */
  :root[data-theme="dark"]{
    --page-bg:#07111a;
    --card-bg: rgba(255,255,255,0.02);
    --text:#eaf6ff;
    --muted:var(--muted-dark);
    --input-bg:rgba(255,255,255,0.01);
    --btn-text:#fff;
    --header-shadow: rgba(0,0,0,0.6);
    --header-bg: #07111a;
  }
  :root[data-theme="light"]{
    --page-bg:#f3f7fb;
    --card-bg:#ffffff;
    --text:#071021;
    --muted:var(--muted-light);
    --input-bg:#ffffff;
    --btn-text:#fff;
    --header-shadow: rgba(0,0,0,0.06);
    --header-bg: #ffffff;
  }

  html,body{height:100%;margin:0;overflow-x:hidden;background:var(--page-bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:var(--maxw);margin:28px auto;padding:18px;box-sizing:border-box}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  .logo{width:56px;height:56px;border-radius:12px;background:var(--card-bg);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--text);box-shadow:var(--shadow)}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .main-card{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
  textarea{width:100%;min-height:140px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:var(--input-bg);color:var(--text);font-size:14px;box-sizing:border-box;resize:vertical}

  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:16px 0}
  select,button{padding:10px 16px;border-radius:8px;border:1px solid var(--muted);background:var(--card-bg);color:var(--text);cursor:pointer;font-size:14px}
  button{background:var(--accent);border-color:var(--accent);color:var(--btn-text)}
  button:hover{opacity:0.9}
  button:disabled{background:var(--muted);cursor:not-allowed}

  .queue{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--accent);color:white;border-radius:8px;margin:12px 0;font-size:13px}
  .queue.hidden{display:none}

  .progress-container{display:flex;gap:8px;align-items:center;margin:12px 0}
  .progress-bar{background:var(--muted);height:8px;border-radius:4px;overflow:hidden;flex:1}
  .progress-fill{background:var(--green);height:100%;transition:width 0.3s ease;width:0%;border-radius:4px}
  .progress-text{font-size:12px;color:var(--muted)}

  .results{margin-top:24px}
  .results table{width:100%;border-collapse:collapse;margin-top:12px}
  .results th,.results td{padding:8px 12px;border-bottom:1px solid var(--card-border);text-align:left}
  .results th{background:var(--muted-light);color:var(--text)}
  .results tr:nth-child(even){background:var(--card-bg)}
  .results tr:hover{background:var(--accent)}

  .download-link{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;background:var(--green);color:white;border-radius:8px;text-decoration:none;font-weight:500;margin-top:16px}
  .download-link:hover{opacity:0.9}

  .status{margin:12px 0;padding:12px;border-radius:8px;background:var(--card-bg);border-left:4px solid var(--accent)}
  .status.success{border-left-color:var(--green)}
  .status.error{border-left-color:#ef4444;color:#ef4444}

  .site-detect{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--card-bg);border-radius:8px;margin:8px 0}
  .site-chip{background:var(--accent);color:white;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:500}

  .url-count{display:flex;align-items:center;gap:4px;font-size:13px;color:var(--muted)}

  @media (max-width:600px){
    .controls{flex-direction:column}
    .wrap{margin:12px;padding:12px}
    .logo{width:48px;height:48px}
    .results table{font-size:12px}
    .results th,.results td{padding:6px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">E</div>
      <div>
        <h1>Product Data Extractor</h1>
        <p class="lead">Paste URLs from Macy's, Kohl's, or Belk â€” get structured data with queue management.</p>
      </div>
    </header>

    <div class="main-card">
      <div class="site-detect">
        <span>Detected Site:</span>
        <span class="site-chip" id="siteChip">Macy's</span>
      </div>

      <label for="urls">URLs (one per line)</label>
      <textarea id="urls" placeholder="Paste product URLs here (Macy's, Kohl's, Belk)"></textarea>
      <div class="url-count">
        <span>URLs:</span>
        <span id="urlCount">0</span>
      </div>

      <div class="controls">
        <button id="submitBtn" disabled>Submit to Queue</button>
        <button id="clearBtn">Clear</button>
      </div>

      <div id="queueInfo" class="queue hidden">
        <span id="queuePosition">1</span>
        <span>/</span>
        <span id="queueTotal">1</span>
        <span>â€”</span>
        <span id="queueStatus">Queued</span>
      </div>

      <div class="progress-container hidden" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span class="progress-text" id="progressText">0%</span>
      </div>

      <div id="statusArea" class="status">Ready to submit URLs.</div>

      <div id="resultsArea" class="results" style="display:none">
        <h3>Results (<span id="rowsInfo">0</span> rows)</h3>
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div class="download-link hidden" id="downloadLink">
          <a id="downloadBtn" href="#" download>ðŸ“¥ Download CSV</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const NGROK_URL = 'https://synonymous-julie-trilaterally.ngrok-free.dev';  // REPLACE WITH YOUR ACTUAL NGROK URL

    let socket;
    let userId;
    let totalOffers = 0;
    let progressInterval;

    // Site detection from URL
    function detectSiteFromUrl(url) {
      if (!url) return 'macys';
      const u = url.toLowerCase();
      if (u.includes('macys')) return 'macys';
      if (u.includes('kohls')) return 'kohls';
      if (u.includes('belk')) return 'belk';
      return 'macys'; // default
    }

    // Connect Socket.io
    function connectSocket() {
      socket = io(NGROK_URL);
      socket.on('queue_update', (data) => {
        document.getElementById('queuePosition').textContent = data.position || 1;
        document.getElementById('queueTotal').textContent = data.total || 1;
        document.getElementById('queueStatus').textContent = data.message || 'Queued';
        document.getElementById('queueInfo').classList.remove('hidden');
      });
      socket.on('extraction_complete', async (data) => {
        document.getElementById('statusArea').innerHTML = '<div class="status success">Complete! Loading preview...</div>';
        await renderTableFromCsv(data.downloadUrl);
        document.getElementById('downloadBtn').href = data.downloadUrl;
        document.getElementById('downloadLink').classList.remove('hidden');
        stopProgress();
      });
      socket.on('progress', (data) => {
        updateProgress(data.done, data.total);
      });
    }

    // Submit to queue
    async function submitToQueue() {
      const urlsRaw = document.getElementById('urls').value.trim();
      if (!urlsRaw) return alert('Add URLs!');
      const urls = urlsRaw.split(/\r?\n/).map(u => u.trim()).filter(u => u);
      const site = detectSiteFromUrl(urls[0]);  // Auto-detect from first URL
      document.getElementById('siteChip').textContent = site;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('statusArea').innerHTML = '<div class="status">Submitting to queue...</div>';

      try {
        const response = await fetch(`${NGROK_URL}/queue_submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ site, urls })
        });
        if (!response.ok) throw new Error(await response.text());
        const json = await response.json();
        userId = json.userId;
        socket.emit('join_queue', userId);
        connectSocket();
        document.getElementById('statusArea').innerHTML = `<div class="status">Queued! Position ${json.position}/${json.total}</div>`;
      } catch (err) {
        console.error('Submit error', err);
        alert('Submit failed: ' + err.message);
        document.getElementById('statusArea').innerHTML = '<div class="status error">Submit failed</div>';
        document.getElementById('submitBtn').disabled = false;
      }
    }

    // Render CSV preview table
    async function renderTableFromCsv(downloadUrl) {
      try {
        const res = await fetch(downloadUrl);
        if (!res.ok) throw new Error('Preview fetch failed');
        const csv = await res.text();
        const rows = csv.split('\n').map(row => row.split(',').map(cell => cell.trim().replace(/"/g, '')));
        if (rows.length < 2) throw new Error('No data in CSV');

        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        head.innerHTML = '';
        body.innerHTML = '';

        const headerRow = document.createElement('tr');
        rows[0].forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        head.appendChild(headerRow);

        rows.slice(1).forEach((row, index) => {
          if (row.length < 2) return;  // Skip empty
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
          });
          body.appendChild(tr);
        });

        document.getElementById('rowsInfo').textContent = rows.slice(1).length;
        document.getElementById('resultsArea').style.display = 'block';
      } catch (err) {
        console.error('Preview error:', err);
        document.getElementById('statusArea').innerHTML = `<div class="status error">Preview failed: ${err.message}. Download anyway.</div>`;
      }
    }

    // Progress visualization
    function startProgressAuto() {
      progressInterval = setInterval(() => {
        const done = Math.floor(Math.random() * 101);  // Simulated
        updateProgress(done, 100);
      }, 2000);
    }

    function updateProgress(done, total) {
      const percent = Math.min(100, (done / total) * 100);
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressText').textContent = `${Math.round(percent)}% (${done}/${total})`;
      document.getElementById('progressContainer').classList.remove('hidden');
    }

    function stopProgress() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      document.getElementById('progressContainer').classList.add('hidden');
    }

    function resetProgress() {
      stopProgress();
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('progressText').textContent = '0%';
    }

    // UI wiring
    document.getElementById('submitBtn').addEventListener('click', (e) => {
      e.preventDefault();
      submitToQueue();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('urls').value = '';
      document.getElementById('resultsArea').style.display = 'none';
      document.getElementById('downloadLink').classList.add('hidden');
      document.getElementById('rowsInfo').textContent = '0';
      resetProgress();
      document.getElementById('submitBtn').disabled = false;
      updateUrlCountAndSite();
    });

    // URL counter + site detection
    function updateUrlCountAndSite() {
      const raw = document.getElementById('urls').value || '';
      const urls = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      document.getElementById('urlCount').textContent = urls.length;
      if (urls.length > 0) {
        const detected = detectSiteFromUrl(urls[0]);
        document.getElementById('siteChip').textContent = detected;
      }
      document.getElementById('submitBtn').disabled = urls.length === 0;
    }

    function detectSiteFromUrl(url) {
      if (!url) return 'macys';
      const u = url.toLowerCase();
      if (u.includes('macys')) return 'macys';
      if (u.includes('kohls')) return 'kohls';
      if (u.includes('belk')) return 'belk';
      return 'macys';
    }

    document.getElementById('urls').addEventListener('input', updateUrlCountAndSite);
    document.getElementById('urls').addEventListener('paste', () => setTimeout(updateUrlCountAndSite, 50));
    updateUrlCountAndSite();  // Init

    // Expose for debug
    window.__EXTRACTOR = { renderTableFromCsv, submitToQueue, connectSocket, setProgress, startProgressAuto, completeProgress };

    // Init: hide progress
    resetProgress();
  </script>
</body>
</html>
